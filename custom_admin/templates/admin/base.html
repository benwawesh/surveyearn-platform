<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SurveyEarn Management{% endblock %}</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>">

    <!-- Chart.js for reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    {% block extra_head %}{% endblock %}

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Animation for smooth transitions */
        .sidebar-link {
            transition: all 0.2s ease-in-out;
        }

        /* Notification styles */
        .notification {
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Submenu styles */
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .submenu.active {
            max-height: 300px;
        }
        .submenu-item {
            padding-left: 2.5rem;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Navigation Header -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <h1 class="text-xl font-bold text-gray-900">
                        <i class="fas fa-chart-line mr-2 text-blue-600"></i>
                        SurveyEarn Management
                    </h1>
                </div>

                <div class="flex items-center space-x-4">
                    <!-- Quick Stats in Header -->
                    <div class="hidden md:flex items-center space-x-6 text-sm">
                        <div class="flex items-center space-x-1">
                            <i class="fas fa-users text-blue-500"></i>
                            <span class="text-gray-600">Users:</span>
                            <span class="font-semibold" id="header-users-count">{{ active_users_count|default:0 }}</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <i class="fas fa-money-bill-wave text-green-500"></i>
                            <span class="text-gray-600">Revenue:</span>
                            <span class="font-semibold text-green-600" id="header-revenue">KES 0</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <i class="fas fa-clock text-orange-500"></i>
                            <span class="text-gray-600">Pending:</span>
                            <span class="font-semibold text-orange-600">{{ pending_withdrawals_count|default:0 }}</span>
                        </div>
                    </div>

                    <!-- User Menu -->
                    <div class="flex items-center space-x-3">
                        <span class="text-sm text-gray-700">Welcome, <strong>{{ user.first_name|default:user.username }}</strong></span>
                        <a href="{% url 'custom_admin:logout' %}" class="bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded text-sm text-white transition-colors">
                            <i class="fas fa-sign-out-alt mr-1"></i>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-lg">
            <div class="p-4">
                <ul class="space-y-1">
                    <!-- Dashboard -->
                    <li>
                        <a href="{% url 'custom_admin:dashboard' %}"
                           class="sidebar-link flex items-center space-x-3 p-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 {% if request.resolver_match.url_name == 'dashboard' %}bg-blue-50 text-blue-600 border-r-4 border-blue-600{% endif %}">
                            <i class="fas fa-tachometer-alt w-5"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>

                    <!-- Financial Analytics -->
                    <li>
                        <a href="{% url 'custom_admin:financial_analytics' %}"
                           class="sidebar-link flex items-center space-x-3 p-3 rounded-lg hover:bg-green-50 hover:text-green-600 {% if 'analytics' in request.resolver_match.url_name %}bg-green-50 text-green-600 border-r-4 border-green-600{% endif %}">
                            <i class="fas fa-chart-bar w-5"></i>
                            <span>Financial Analytics</span>
                        </a>
                    </li>

                    <!-- Users -->
                    <li>
                        <a href="{% url 'custom_admin:users' %}"
                           class="sidebar-link flex items-center space-x-3 p-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 {% if 'user' in request.resolver_match.url_name and 'tutorial' not in request.resolver_match.url_name %}bg-blue-50 text-blue-600 border-r-4 border-blue-600{% endif %}">
                            <i class="fas fa-users w-5"></i>
                            <span>Users</span>
                        </a>
                    </li>

                    <!-- Surveys -->
                    <li>
                        <a href="{% url 'custom_admin:surveys' %}"
                           class="sidebar-link flex items-center space-x-3 p-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 {% if 'survey' in request.resolver_match.url_name %}bg-blue-50 text-blue-600 border-r-4 border-blue-600{% endif %}">
                            <i class="fas fa-poll w-5"></i>
                            <span>Surveys</span>
                        </a>
                    </li>

                    <!-- Tutorial Management - EXPANDABLE MENU -->
                    <li>
                        <div class="tutorial-menu">
                            <!-- Main Tutorial Link -->
                            <div class="sidebar-link flex items-center space-x-3 p-3 rounded-lg hover:bg-purple-50 hover:text-purple-600 cursor-pointer {% if 'tutorial' in request.resolver_match.url_name %}bg-purple-50 text-purple-600 border-r-4 border-purple-600{% endif %}"
                                 onclick="toggleSubmenu('tutorial-submenu')">
                                <i class="fas fa-graduation-cap w-5"></i>
                                <span>Tutorials</span>
                                <i class="fas fa-chevron-down ml-auto transition-transform duration-200" id="tutorial-chevron"></i>
                            </div>

                            <!-- Tutorial Submenu -->
                            <div class="submenu {% if 'tutorial' in request.resolver_match.url_name %}active{% endif %}" id="tutorial-submenu">
                                <ul class="mt-2 space-y-1">
                                    <li>
                                        <a href="{% url 'custom_admin:tutorials_dashboard' %}"
                                           class="submenu-item sidebar-link flex items-center space-x-2 p-2 rounded-lg text-sm hover:bg-purple-50 hover:text-purple-600 {% if request.resolver_match.url_name == 'tutorials_dashboard' %}bg-purple-100 text-purple-700{% endif %}">
                                            <i class="fas fa-chart-line w-4"></i>
                                            <span>Dashboard</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="{% url 'custom_admin:tutorial_create' %}"
                                           class="submenu-item sidebar-link flex items-center space-x-2 p-2 rounded-lg text-sm hover:bg-green-50 hover:text-green-600 {% if request.resolver_match.url_name == 'tutorial_create' %}bg-green-100 text-green-700{% endif %}">
                                            <i class="fas fa-plus-circle w-4 text-green-500"></i>
                                            <span>Create Tutorial</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="{% url 'custom_admin:tutorials_list' %}"
                                           class="submenu-item sidebar-link flex items-center space-x-2 p-2 rounded-lg text-sm hover:bg-purple-50 hover:text-purple-600 {% if request.resolver_match.url_name == 'tutorials_list' %}bg-purple-100 text-purple-700{% endif %}">
                                            <i class="fas fa-video w-4"></i>
                                            <span>Manage Tutorials</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="{% url 'custom_admin:categories_list' %}"
                                           class="submenu-item sidebar-link flex items-center space-x-2 p-2 rounded-lg text-sm hover:bg-purple-50 hover:text-purple-600 {% if 'categories' in request.resolver_match.url_name %}bg-purple-100 text-purple-700{% endif %}">
                                            <i class="fas fa-folder w-4"></i>
                                            <span>Categories</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="{% url 'custom_admin:user_progress' %}"
                                           class="submenu-item sidebar-link flex items-center space-x-2 p-2 rounded-lg text-sm hover:bg-purple-50 hover:text-purple-600 {% if request.resolver_match.url_name == 'user_progress' %}bg-purple-100 text-purple-700{% endif %}">
                                            <i class="fas fa-users w-4"></i>
                                            <span>User Progress</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </li>

                    <!-- Withdrawals -->
                    <li>
                        <a href="{% url 'custom_admin:withdrawals' %}"
                           class="sidebar-link flex items-center space-x-3 p-3 rounded-lg hover:bg-orange-50 hover:text-orange-600 {% if 'withdrawal' in request.resolver_match.url_name %}bg-orange-50 text-orange-600 border-r-4 border-orange-600{% endif %}">
                            <i class="fas fa-money-bill-wave w-5"></i>
                            <span>Withdrawals</span>
                            {% if pending_withdrawals_count > 0 %}
                                <span class="ml-auto bg-orange-100 text-orange-600 text-xs px-2 py-1 rounded-full">{{ pending_withdrawals_count }}</span>
                            {% endif %}
                        </a>
                    </li>

                    <!-- Transactions -->
                    <li>
                        <a href="{% url 'custom_admin:transactions' %}"
                           class="sidebar-link flex items-center space-x-3 p-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 {% if 'transaction' in request.resolver_match.url_name and 'tutorial' not in request.resolver_match.url_name %}bg-blue-50 text-blue-600 border-r-4 border-blue-600{% endif %}">
                            <i class="fas fa-exchange-alt w-5"></i>
                            <span>Transactions</span>
                        </a>
                    </li>

                    <!-- Settings -->
                    <li>
                        <a href="{% url 'custom_admin:settings_dashboard' %}"
                           class="sidebar-link flex items-center space-x-3 p-3 rounded-lg hover:bg-purple-50 hover:text-purple-600 {% if 'settings' in request.resolver_match.url_name %}bg-purple-50 text-purple-600 border-r-4 border-purple-600{% endif %}">
                            <i class="fas fa-cogs w-5"></i>
                            <span>Settings</span>
                        </a>
                    </li>

                    <!-- Reports -->
                    <li>
                        <a href="{% url 'custom_admin:reports' %}"
                           class="sidebar-link flex items-center space-x-3 p-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 {% if request.resolver_match.url_name == 'reports' %}bg-blue-50 text-blue-600 border-r-4 border-blue-600{% endif %}">
                            <i class="fas fa-file-chart-bar w-5"></i>
                            <span>Reports</span>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Enhanced Quick Stats in Sidebar -->
            <div class="p-4 border-t border-gray-200">
                <h3 class="text-sm font-semibold text-gray-600 mb-3">Real-time Stats</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600 flex items-center">
                            <i class="fas fa-users text-blue-500 mr-2"></i>
                            Active Users:
                        </span>
                        <span class="font-semibold" id="sidebar-users-count">{{ active_users_count|default:0 }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600 flex items-center">
                            <i class="fas fa-poll text-green-500 mr-2"></i>
                            Active Surveys:
                        </span>
                        <span class="font-semibold">{{ active_surveys_count|default:0 }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600 flex items-center">
                            <i class="fas fa-graduation-cap text-purple-500 mr-2"></i>
                            Active Tutorials:
                        </span>
                        <span class="font-semibold">{{ active_tutorials_count|default:0 }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600 flex items-center">
                            <i class="fas fa-clock text-orange-500 mr-2"></i>
                            Pending Withdrawals:
                        </span>
                        <span class="font-semibold text-orange-600">{{ pending_withdrawals_count|default:0 }}</span>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-gray-100">
                        <span class="text-gray-600 flex items-center">
                            <i class="fas fa-chart-line text-green-500 mr-2"></i>
                            Total Revenue:
                        </span>
                        <span class="font-semibold text-green-600" id="sidebar-revenue">KES 0</span>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="mt-4 pt-3 border-t border-gray-200">
                    <h4 class="text-xs font-semibold text-gray-500 uppercase mb-2">Quick Actions</h4>
                    <div class="space-y-2">
                        <a href="{% url 'custom_admin:financial_analytics' %}"
                           class="block w-full text-center bg-blue-500 hover:bg-blue-600 text-white text-xs py-2 px-3 rounded transition-colors">
                            <i class="fas fa-chart-bar mr-1"></i>View Analytics
                        </a>
                        <a href="{% url 'custom_admin:tutorial_create' %}"
                           class="block w-full text-center bg-green-500 hover:bg-green-600 text-white text-xs py-2 px-3 rounded transition-colors">
                            <i class="fas fa-plus mr-1"></i>Create Tutorial
                        </a>
                        <a href="{% url 'custom_admin:tutorials_dashboard' %}"
                           class="block w-full text-center bg-purple-500 hover:bg-purple-600 text-white text-xs py-2 px-3 rounded transition-colors">
                            <i class="fas fa-graduation-cap mr-1"></i>Tutorial Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto">
            <!-- Page Header -->
            <div class="bg-white shadow-sm border-b border-gray-200">
                <div class="px-6 py-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">{% block page_title %}Dashboard{% endblock %}</h2>
                            <p class="text-gray-600 mt-1">{% block page_description %}Overview of your survey platform{% endblock %}</p>
                        </div>

                        <!-- Page Actions -->
                        <div class="flex items-center space-x-3">
                            {% block page_actions %}
                            {% endblock %}

                            <!-- Real-time Indicator -->
                            <div class="flex items-center space-x-2 text-sm text-gray-500">
                                <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                <span id="last-update">Live</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            {% if messages %}
                <div class="px-6 py-4">
                    {% for message in messages %}
                        <div class="notification mb-4 p-4 rounded-lg flex items-center {% if message.tags == 'success' %}bg-green-50 text-green-800 border border-green-200{% elif message.tags == 'error' %}bg-red-50 text-red-800 border border-red-200{% elif message.tags == 'warning' %}bg-yellow-50 text-yellow-800 border border-yellow-200{% else %}bg-blue-50 text-blue-800 border border-blue-200{% endif %}">
                            <i class="fas {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %} mr-3"></i>
                            <span>{{ message }}</span>
                            <button onclick="this.parentElement.remove()" class="ml-auto text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Content -->
            <div class="px-6 py-6">
                {% block content %}
                {% endblock %}
            </div>
        </main>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- JavaScript -->
    <script>
        // Toggle submenu function
        function toggleSubmenu(submenuId) {
            const submenu = document.getElementById(submenuId);
            const chevron = document.getElementById(submenuId.replace('-submenu', '-chevron'));

            submenu.classList.toggle('active');

            if (chevron) {
                if (submenu.classList.contains('active')) {
                    chevron.style.transform = 'rotate(180deg)';
                } else {
                    chevron.style.transform = 'rotate(0deg)';
                }
            }
        }

        // Auto-hide messages after 5 seconds
        setTimeout(function() {
            const messages = document.querySelectorAll('.notification');
            messages.forEach(function(message) {
                message.style.transition = 'opacity 0.5s, transform 0.5s';
                message.style.opacity = '0';
                message.style.transform = 'translateX(100%)';
                setTimeout(function() {
                    message.remove();
                }, 500);
            });
        }, 5000);

        // Real-time stats update
        async function updateRealTimeStats() {
            try {
                const response = await fetch('/management/analytics/api/?metric=overview');
                const data = await response.json();

                // Update header stats
                if (document.getElementById('header-revenue')) {
                    document.getElementById('header-revenue').textContent = 'KES ' + parseFloat(data.total_revenue || 0).toFixed(0);
                }

                // Update sidebar stats
                if (document.getElementById('sidebar-revenue')) {
                    document.getElementById('sidebar-revenue').textContent = 'KES ' + parseFloat(data.total_revenue || 0).toFixed(0);
                }

                if (document.getElementById('sidebar-users-count')) {
                    document.getElementById('sidebar-users-count').textContent = data.active_users || 0;
                }

                if (document.getElementById('header-users-count')) {
                    document.getElementById('header-users-count').textContent = data.active_users || 0;
                }

                // Update last update time
                if (document.getElementById('last-update')) {
                    document.getElementById('last-update').textContent = 'Updated: ' + new Date().toLocaleTimeString();
                }

            } catch (error) {
                console.error('Error updating real-time stats:', error);
            }
        }

        // Show notification function
        function showNotification(message, type = 'info', duration = 3000) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');

            const typeClasses = {
                'success': 'bg-green-500 text-white',
                'error': 'bg-red-500 text-white',
                'warning': 'bg-yellow-500 text-black',
                'info': 'bg-blue-500 text-white'
            };

            notification.className = `notification px-6 py-3 rounded-lg shadow-lg ${typeClasses[type] || typeClasses.info} flex items-center space-x-2`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info'} mr-2"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-2 opacity-75 hover:opacity-100">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(notification);

            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.transition = 'opacity 0.3s, transform 0.3s';
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
        }

        // Confirm delete actions
        function confirmAction(message) {
            return confirm(message || 'Are you sure you want to perform this action?');
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-KE', {
                style: 'currency',
                currency: 'KES'
            }).format(amount);
        }

        // Format date
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateRealTimeStats();

            // Update stats every 30 seconds
            setInterval(updateRealTimeStats, 30000);

            // Auto-expand tutorial submenu if on tutorial page
            if (window.location.pathname.includes('/tutorials/')) {
                const tutorialSubmenu = document.getElementById('tutorial-submenu');
                const tutorialChevron = document.getElementById('tutorial-chevron');
                if (tutorialSubmenu && !tutorialSubmenu.classList.contains('active')) {
                    tutorialSubmenu.classList.add('active');
                    if (tutorialChevron) {
                        tutorialChevron.style.transform = 'rotate(180deg)';
                    }
                }
            }
        });

        // Global functions for other templates
        window.showNotification = showNotification;
        window.confirmAction = confirmAction;
        window.formatCurrency = formatCurrency;
        window.formatDate = formatDate;
        window.toggleSubmenu = toggleSubmenu;
    </script>

    {% block extra_js %}
    {% endblock %}
</body>
</html>