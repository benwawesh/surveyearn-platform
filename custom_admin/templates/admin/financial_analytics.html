{% extends 'custom_admin/base.html' %}

{% block title %}Financial Analytics - SurveyEarn Admin{% endblock %}

{% block page_title %}Financial Analytics{% endblock %}
{% block page_description %}Comprehensive financial performance and cash flow analysis{% endblock %}

{% block page_actions %}
<div class="flex space-x-3">
    <button onclick="refreshDashboard()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
        <i class="fas fa-sync-alt mr-2"></i>Refresh Data
    </button>
    <div class="bg-gray-400 opacity-50 px-4 py-2 rounded-lg text-sm text-white cursor-not-allowed">
        <i class="fas fa-download mr-2"></i>Export CSV (Coming Soon)
    </div>
    <a href="{% url 'custom_admin:dashboard' %}" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
    </a>
</div>
{% endblock %}

{% block content %}

<!-- Financial Performance Overview -->
<div class="bg-gradient-to-r from-green-600 to-blue-600 rounded-xl shadow-lg p-6 mb-8 text-white">
    <h2 class="text-2xl font-bold mb-6 flex items-center">
        <i class="fas fa-chart-line mr-3"></i>
        Financial Performance Overview
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <!-- Total Revenue -->
        <div class="bg-white bg-opacity-20 rounded-lg p-4 backdrop-blur-sm">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium opacity-90">Total Revenue</h3>
                <i class="fas fa-arrow-up text-green-300 text-lg"></i>
            </div>
            <p class="text-2xl font-bold" id="totalRevenue">KES {{ total_revenue|floatformat:2 }}</p>
            <div class="text-xs opacity-75 mt-2">
                <div>Registration Fees: KES {{ revenue_streams.registration_fees|floatformat:2 }}</div>
                <div>Service Fees: KES {{ revenue_streams.service_fees|floatformat:2 }}</div>
            </div>
        </div>

        <!-- Total Expenses -->
        <div class="bg-white bg-opacity-20 rounded-lg p-4 backdrop-blur-sm">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium opacity-90">Total Expenses</h3>
                <i class="fas fa-arrow-down text-red-300 text-lg"></i>
            </div>
            <p class="text-2xl font-bold" id="totalExpenses">KES {{ total_expenses|floatformat:2 }}</p>
            <div class="text-xs opacity-75 mt-2">
                <div>Survey Compensation: KES {{ operating_expenses.survey_compensation|floatformat:2 }}</div>
                <div>Referral Commissions: KES {{ operating_expenses.referral_commissions|floatformat:2 }}</div>
                <div>User Withdrawals: KES {{ operating_expenses.user_withdrawals|floatformat:2 }}</div>
            </div>
        </div>

        <!-- Net Profit -->
        <div class="bg-white bg-opacity-20 rounded-lg p-4 backdrop-blur-sm">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium opacity-90">Net Profit</h3>
                <i class="fas fa-balance-scale text-yellow-300 text-lg"></i>
            </div>
            <p class="text-2xl font-bold {% if net_profit >= 0 %}text-green-300{% else %}text-red-300{% endif %}" id="netProfit">
                KES {{ net_profit|floatformat:2 }}
            </p>
            <div class="text-xs opacity-75 mt-2">
                {% if net_profit >= 0 %}
                <div class="text-green-300">✓ Profitable Operations</div>
                {% else %}
                <div class="text-red-300">⚠ Operating at Loss</div>
                {% endif %}
            </div>
        </div>

        <!-- Profit Margin -->
        <div class="bg-white bg-opacity-20 rounded-lg p-4 backdrop-blur-sm">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium opacity-90">Profit Margin</h3>
                <i class="fas fa-percentage text-blue-300 text-lg"></i>
            </div>
            <p class="text-2xl font-bold" id="profitMargin">{{ profit_margin|floatformat:1 }}%</p>
            <div class="text-xs opacity-75 mt-2">
                <div>Platform efficiency metric</div>
                <div>Outstanding Liabilities: KES {{ outstanding_liabilities|floatformat:2 }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Revenue Streams & Operating Expenses -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Revenue Streams -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-green-700 flex items-center">
                <i class="fas fa-chart-line mr-2"></i>
                Revenue Streams (This Month)
            </h3>
            <span class="text-sm text-gray-500">{{ current_month }}</span>
        </div>
        <div class="space-y-4">
            <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg border-l-4 border-green-500">
                <div>
                    <p class="font-medium text-gray-900">Registration Fees</p>
                    <p class="text-sm text-gray-600">{{ current_month_stats.new_registrations }} new registrations</p>
                </div>
                <p class="text-lg font-bold text-green-600">KES {{ current_month_stats.registration_revenue|floatformat:2 }}</p>
            </div>
            <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                <div>
                    <p class="font-medium text-gray-900">Service Fees</p>
                    <p class="text-sm text-gray-600">Platform fees & adjustments</p>
                </div>
                <p class="text-lg font-bold text-blue-600">KES {{ current_month_stats.service_fees|floatformat:2 }}</p>
            </div>
        </div>
        <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="flex justify-between items-center">
                <p class="font-semibold text-gray-900">Total Revenue (This Month)</p>
                <p class="text-xl font-bold text-green-600">KES {{ current_month_stats.total_revenue|floatformat:2 }}</p>
            </div>
        </div>
    </div>

    <!-- Operating Expenses -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-red-700 flex items-center">
                <i class="fas fa-chart-bar mr-2"></i>
                Operating Expenses (This Month)
            </h3>
            <span class="text-sm text-gray-500">{{ current_month }}</span>
        </div>
        <div class="space-y-4">
            <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg border-l-4 border-red-500">
                <div>
                    <p class="font-medium text-gray-900">Survey Compensation</p>
                    <p class="text-sm text-gray-600">{{ current_month_stats.survey_responses }} responses paid</p>
                </div>
                <p class="text-lg font-bold text-red-600">KES {{ current_month_stats.survey_compensation|floatformat:2 }}</p>
            </div>
            <div class="flex justify-between items-center p-3 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                <div>
                    <p class="font-medium text-gray-900">Referral Commissions</p>
                    <p class="text-sm text-gray-600">{{ current_month_stats.referral_count }} commissions paid</p>
                </div>
                <p class="text-lg font-bold text-orange-600">KES {{ current_month_stats.referral_commissions|floatformat:2 }}</p>
            </div>
            <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
                <div>
                    <p class="font-medium text-gray-900">User Withdrawals</p>
                    <p class="text-sm text-gray-600">{{ current_month_stats.withdrawal_count }} processed</p>
                </div>
                <p class="text-lg font-bold text-yellow-600">KES {{ current_month_stats.user_withdrawals|floatformat:2 }}</p>
            </div>
        </div>
        <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="flex justify-between items-center">
                <p class="font-semibold text-gray-900">Total Expenses (This Month)</p>
                <p class="text-xl font-bold text-red-600">KES {{ current_month_stats.total_expenses|floatformat:2 }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Financial Performance Chart -->
<div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 mb-8">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900">Revenue vs Expenses Trend</h3>
        <span class="text-sm text-gray-500">Last 30 days</span>
    </div>
    <div style="height: 400px;">
        <canvas id="revenueExpenseChart"></canvas>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Revenue Growth -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Revenue Growth</h3>
            <i class="fas fa-trending-up text-green-600 text-xl"></i>
        </div>
        <div class="text-center">
            <p class="text-3xl font-bold {% if revenue_growth >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                {% if revenue_growth >= 0 %}+{% endif %}{{ revenue_growth|floatformat:1 }}%
            </p>
            <p class="text-sm text-gray-600 mt-1">vs last month</p>
        </div>
        <div class="mt-4 bg-gray-50 rounded-lg p-3">
            <div class="flex justify-between text-sm">
                <span class="text-gray-600">This Month:</span>
                <span class="font-semibold">KES {{ current_month_revenue|floatformat:2 }}</span>
            </div>
            <div class="flex justify-between text-sm mt-1">
                <span class="text-gray-600">Last Month:</span>
                <span class="font-semibold">KES {{ last_month_revenue|floatformat:2 }}</span>
            </div>
        </div>
    </div>

    <!-- Expense Ratio -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Expense Ratio</h3>
            <i class="fas fa-chart-pie text-blue-600 text-xl"></i>
        </div>
        <div class="text-center">
            <p class="text-3xl font-bold text-blue-600">{{ expense_ratio|floatformat:1 }}%</p>
            <p class="text-sm text-gray-600 mt-1">of revenue as expenses</p>
        </div>
        <div class="mt-4">
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: {{ expense_ratio|floatformat:0 }}%"></div>
            </div>
            <div class="flex justify-between text-xs text-gray-500 mt-2">
                <span>0%</span>
                <span>Optimal: 60-80%</span>
                <span>100%</span>
            </div>
        </div>
    </div>

    <!-- Outstanding Liabilities -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Outstanding Liabilities</h3>
            <i class="fas fa-exclamation-triangle text-orange-600 text-xl"></i>
        </div>
        <div class="text-center">
            <p class="text-3xl font-bold text-orange-600">KES {{ outstanding_liabilities|floatformat:2 }}</p>
            <p class="text-sm text-gray-600 mt-1">pending user payouts</p>
        </div>
        <div class="mt-4 space-y-2">
            <div class="flex justify-between text-sm">
                <span class="text-gray-600">User Balances:</span>
                <span class="font-semibold">KES {{ total_user_balances|floatformat:2 }}</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-gray-600">Pending Withdrawals:</span>
                <span class="font-semibold">KES {{ pending_withdrawals|floatformat:2 }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Performance Analytics Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Monthly Revenue Chart -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Monthly Revenue Trend</h3>
            <span class="text-sm text-gray-500">Last 12 months</span>
        </div>
        <div style="height: 300px;">
            <canvas id="monthlyRevenueChart"></canvas>
        </div>
    </div>

    <!-- Transaction Volume Chart -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Transaction Volume</h3>
            <span class="text-sm text-gray-500">Last 30 days</span>
        </div>
        <div style="height: 300px;">
            <canvas id="dailyTransactionsChart"></canvas>
        </div>
    </div>
</div>

<!-- Business Intelligence -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- User Balance Distribution -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">User Balance Distribution</h3>
        <div style="height: 300px;">
            <canvas id="balanceDistributionChart"></canvas>
        </div>
    </div>

    <!-- Top Performing Surveys -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Performing Surveys</h3>
        <div class="space-y-3">
            {% for survey in top_surveys %}
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div>
                    <p class="font-medium text-gray-900 truncate">{{ survey.title|default:"Survey "|add:forloop.counter }}</p>
                    <p class="text-sm text-gray-600">{{ survey.response_count }} responses</p>
                </div>
                <div class="text-right">
                    <p class="font-semibold text-green-600">KES {{ survey.total_paid|floatformat:2 }}</p>
                    <div class="w-16 bg-gray-200 rounded-full h-2 mt-1">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: {{ survey.completion_rate|default:50 }}%"></div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-4 text-gray-500">
                <i class="fas fa-poll text-2xl mb-2"></i>
                <p>No survey data available</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Recent High-Value Transactions -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent High-Value Transactions</h3>
        <div class="space-y-3 max-h-80 overflow-y-auto">
            {% for transaction in high_value_transactions %}
            <div class="flex items-center justify-between p-3 border-l-4
                {% if transaction.transaction_type == 'withdrawal' %}border-red-400 bg-red-50
                {% elif transaction.transaction_type == 'survey_payment' %}border-green-400 bg-green-50
                {% elif transaction.transaction_type == 'bonus' %}border-blue-400 bg-blue-50
                {% else %}border-purple-400 bg-purple-50{% endif %}">
                <div>
                    <p class="font-medium text-gray-900">{{ transaction.user.phone_number|default:transaction.user.username }}</p>
                    <p class="text-sm text-gray-600">{{ transaction.get_transaction_type_display|default:transaction.transaction_type|title }}</p>
                </div>
                <div class="text-right">
                    <p class="font-semibold
                        {% if transaction.transaction_type == 'withdrawal' %}text-red-600
                        {% else %}text-green-600{% endif %}">
                        KES {{ transaction.amount|floatformat:2 }}
                    </p>
                    <p class="text-xs text-gray-500">{{ transaction.created_at|timesince }} ago</p>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-4 text-gray-500">
                <i class="fas fa-inbox text-2xl mb-2"></i>
                <p>No high-value transactions</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- System Configuration -->
<div class="mt-8 bg-white rounded-xl shadow-sm p-6 border border-gray-100">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Current System Configuration</h3>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="p-4 bg-gray-50 rounded-lg">
            <p class="text-sm text-gray-600">Registration Fee</p>
            <p class="text-xl font-bold text-gray-900">KES {{ system_settings.registration_fee|default:"500" }}</p>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg">
            <p class="text-sm text-gray-600">Survey Compensation</p>
            <p class="text-xl font-bold text-gray-900">KES {{ system_settings.survey_base_payment|default:"10" }}</p>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg">
            <p class="text-sm text-gray-600">Referral Commission</p>
            <p class="text-xl font-bold text-gray-900">{{ system_settings.referral_commission_rate|default:"0.1"|floatformat:1 }}%</p>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg">
            <p class="text-sm text-gray-600">Minimum Withdrawal</p>
            <p class="text-xl font-bold text-gray-900">KES {{ system_settings.minimum_withdrawal_amount|default:"100" }}</p>
        </div>
    </div>
</div>

// Replace the chart initialization section in your template with this dynamic version

<script>
// Chart variables
let monthlyRevenueChart, dailyTransactionsChart, balanceDistributionChart, revenueExpenseChart;

// Chart data - fully dynamic from backend
const monthlyRevenueData = {{ monthly_revenue_data|safe|default:"[]" }};
const dailyTransactionsData = {{ daily_transactions_data|safe|default:"[]" }};
const balanceRanges = {{ balance_ranges|safe|default:"{}" }};
const revenueExpenseData = {{ revenue_expense_data|safe|default:"[]" }};

// DYNAMIC: Get system settings for chart styling
const systemSettings = {
    registrationFee: {{ system_settings.registration_fee|default:0 }},
    commissionRate: {{ system_settings.referral_commission_rate|default:0 }},
    minWithdrawal: {{ system_settings.minimum_withdrawal_amount|default:0 }}
};

    monthlyRevenueData,
    dailyTransactionsData,
    balanceRanges,
    revenueExpenseData,
    systemSettings
});

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    if (typeof Chart !== 'undefined') {
        initializeCharts();
    } else {
        setTimeout(initializeCharts, 500);
    }
});

function initializeCharts() {
    try {
        initializeRevenueExpenseChart();
        initializeMonthlyRevenueChart();
        initializeDailyTransactionsChart();
        initializeBalanceDistributionChart();
    } catch (error) {
        console.error('Error initializing charts:', error);
        showNotification('Error loading charts. Please refresh the page.', 'error');
    }
}

// DYNAMIC: Revenue vs Expense Chart
function initializeRevenueExpenseChart() {
    const ctx = document.getElementById('revenueExpenseChart');
    if (!ctx) return;

    let labels = [];
    let revenueData = [];
    let expenseData = [];
    let profitData = [];

    if (Array.isArray(revenueExpenseData) && revenueExpenseData.length > 0) {
        labels = revenueExpenseData.map(item => {
            const date = new Date(item.date);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        revenueData = revenueExpenseData.map(item => item.revenue || 0);
        expenseData = revenueExpenseData.map(item => item.expenses || 0);
        profitData = revenueExpenseData.map(item => (item.revenue || 0) - (item.expenses || 0));
    } else {
        // DYNAMIC: Create empty data based on current date, not hardcoded values
        const today = new Date();
        for (let i = 29; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            revenueData.push(0);
            expenseData.push(0);
            profitData.push(0);
        }
    }

    // DYNAMIC: Distinct colors for revenue, expenses, and profit
    const revenueColor = 'rgb(34, 197, 94)';     // Green for revenue
    const expenseColor = 'rgb(239, 68, 68)';     // Red for expenses
    const profitColor = 'rgb(168, 85, 247)';     // Purple for net profit

    revenueExpenseChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Revenue',
                    data: revenueData,
                    borderColor: revenueColor,
                    backgroundColor: revenueColor.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4
                },
                {
                    label: 'Expenses',
                    data: expenseData,
                    borderColor: expenseColor,
                    backgroundColor: expenseColor.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4
                },
                {
                    label: 'Net Profit',
                    data: profitData,
                    borderColor: profitColor,
                    backgroundColor: profitColor.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': KES ' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                        callback: function(value) {
                            return 'KES ' + value.toLocaleString();
                        }
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                }
            }
        }
    });
}

// DYNAMIC: Monthly Revenue Chart
function initializeMonthlyRevenueChart() {
    const ctx = document.getElementById('monthlyRevenueChart');
    if (!ctx) return;

    let labels = [];
    let data = [];

    if (Array.isArray(monthlyRevenueData) && monthlyRevenueData.length > 0) {
        labels = monthlyRevenueData.map(item => {
            if (item && item.month) {
                const date = new Date(item.month);
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            }
            return 'N/A';
        });
        data = monthlyRevenueData.map(item => parseFloat(item.total) || 0);
    } else {
        // DYNAMIC: Generate months based on current date
        const today = new Date();
        for (let i = 5; i >= 0; i--) {
            const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
            labels.push(date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }));
            data.push(0);
        }
    }

    // DYNAMIC: Chart styling based on data range
    const maxValue = Math.max(...data);
    const chartColor = maxValue > systemSettings.registrationFee * 10 ? 'rgb(34, 197, 94)' : 'rgb(59, 130, 246)';

    monthlyRevenueChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: `Monthly Revenue (KES)`,
                data: data,
                borderColor: chartColor,
                backgroundColor: chartColor.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: chartColor,
                pointBorderColor: chartColor,
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Revenue: KES ' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'KES ' + value.toLocaleString();
                        }
                    },
                    grid: { color: 'rgba(0, 0, 0, 0.1)' }
                },
                x: { grid: { color: 'rgba(0, 0, 0, 0.1)' } }
            }
        }
    });
}

// DYNAMIC: Daily Transactions Chart
function initializeDailyTransactionsChart() {
    const ctx = document.getElementById('dailyTransactionsChart');
    if (!ctx) return;

    let labels = [];
    let surveyPayments = [];
    let withdrawals = [];
    let adjustments = [];
    let registrationFees = [];
    let referralCommissions = [];

    if (Array.isArray(dailyTransactionsData) && dailyTransactionsData.length > 0) {
        labels = dailyTransactionsData.map(item => {
            if (item && item.day) {
                const date = new Date(item.day);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            return 'N/A';
        });
        surveyPayments = dailyTransactionsData.map(item => item.survey_payments || 0);
        withdrawals = dailyTransactionsData.map(item => item.withdrawals || 0);
        adjustments = dailyTransactionsData.map(item => item.adjustments || 0);
        registrationFees = dailyTransactionsData.map(item => item.registration_fees || 0);
        referralCommissions = dailyTransactionsData.map(item => item.referral_commissions || 0);
    } else {
        // DYNAMIC: Generate last 7 days from current date
        const today = new Date();
        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            surveyPayments.push(0);
            withdrawals.push(0);
            adjustments.push(0);
            registrationFees.push(0);
            referralCommissions.push(0);
        }
    }

    dailyTransactionsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Registration Fees',
                    data: registrationFees,
                    backgroundColor: 'rgba(34, 197, 94, 0.8)',
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Survey Compensation',
                    data: surveyPayments,
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Referral Commissions',
                    data: referralCommissions,
                    backgroundColor: 'rgba(168, 85, 247, 0.8)',
                    borderColor: 'rgba(168, 85, 247, 1)',
                    borderWidth: 1
                },
                {
                    label: 'User Withdrawals',
                    data: withdrawals,
                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Service Adjustments',
                    data: adjustments,
                    backgroundColor: 'rgba(245, 158, 11, 0.8)',
                    borderColor: 'rgba(245, 158, 11, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            return tooltipItems[0].label;
                        },
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + ' transactions';
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    grid: { color: 'rgba(0, 0, 0, 0.1)' }
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    grid: { color: 'rgba(0, 0, 0, 0.1)' }
                }
            }
        }
    });
}

// DYNAMIC: Balance Distribution Chart
function initializeBalanceDistributionChart() {
    const ctx = document.getElementById('balanceDistributionChart');
    if (!ctx) return;

    let labels = [];
    let data = [];

    if (balanceRanges && typeof balanceRanges === 'object' && Object.keys(balanceRanges).length > 0) {
        labels = Object.keys(balanceRanges);
        data = Object.values(balanceRanges);
    } else {
        // DYNAMIC: Create ranges based on system settings
        const minWithdrawal = systemSettings.minWithdrawal || 100;
        const range1 = minWithdrawal / 2;
        const range2 = minWithdrawal;
        const range3 = minWithdrawal * 2;

        labels = [
            `KES 0-${range1}`,
            `KES ${range1+1}-${range2}`,
            `KES ${range2+1}-${range3}`,
            `KES ${range3+1}+`
        ];
        data = [0, 0, 0, 0];
    }

    // DYNAMIC: Generate colors based on number of ranges
    const colors = generateDynamicColors(labels.length);

    balanceDistributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.background,
                borderColor: colors.border,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 15
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                            return context.label + ': ' + context.parsed + ' users (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}

// DYNAMIC: Generate colors based on data
function generateDynamicColors(count) {
    const baseColors = [
        'rgba(239, 68, 68, 0.8)',    // Red
        'rgba(245, 158, 11, 0.8)',   // Orange
        'rgba(34, 197, 94, 0.8)',    // Green
        'rgba(59, 130, 246, 0.8)',   // Blue
        'rgba(168, 85, 247, 0.8)',   // Purple
        'rgba(236, 72, 153, 0.8)',   // Pink
        'rgba(20, 184, 166, 0.8)',   // Teal
        'rgba(251, 191, 36, 0.8)'    // Yellow
    ];

    const borderColors = baseColors.map(color => color.replace('0.8', '1'));

    return {
        background: baseColors.slice(0, count),
        border: borderColors.slice(0, count)
    };
}

// DYNAMIC: Refresh with real-time data
async function refreshDashboard() {
    try {
        showNotification('Refreshing financial data...', 'info', 1000);

        const response = await fetch('{% url "custom_admin:financial_analytics_api" %}?metric=overview');

        if (!response.ok) {
            throw new Error('Network response was not ok');
        }

        const data = await response.json();

        // Update financial metrics dynamically
        updateFinancialMetrics(data);

        // Update charts with new data
        await updateAllCharts();

        showNotification('Financial data updated successfully', 'success');

    } catch (error) {
        console.error('Error refreshing dashboard:', error);
        showNotification('Error refreshing dashboard. Please try again.', 'error');
    }
}

// DYNAMIC: Update financial metrics
function updateFinancialMetrics(data) {
    const elements = {
        'totalRevenue': data.total_revenue,
        'totalExpenses': data.total_expenses,
        'netProfit': data.net_profit,
        'profitMargin': data.profit_margin
    };

    Object.entries(elements).forEach(([elementId, value]) => {
        const element = document.getElementById(elementId);
        if (element && value !== undefined) {
            if (elementId === 'profitMargin') {
                element.textContent = parseFloat(value).toFixed(1) + '%';
            } else if (elementId === 'netProfit') {
                element.textContent = 'KES ' + parseFloat(value).toFixed(2);
                element.className = value >= 0 ?
                    'text-2xl font-bold text-green-300' :
                    'text-2xl font-bold text-red-300';
            } else {
                element.textContent = 'KES ' + parseFloat(value).toFixed(2);
            }
        }
    });
}

// DYNAMIC: Update all charts
async function updateAllCharts() {
    try {
        // Fetch fresh chart data
        const [dailyResponse, overviewResponse] = await Promise.all([
            fetch('{% url "custom_admin:financial_analytics_api" %}?metric=daily_trend'),
            fetch('{% url "custom_admin:financial_analytics_api" %}?metric=overview')
        ]);

        if (dailyResponse.ok) {
            const dailyData = await dailyResponse.json();
            updateChartsWithNewData(dailyData.daily_data);
        }

    } catch (error) {
        console.error('Error updating charts:', error);
    }
}

// Helper function to show notifications
function showNotification(message, type, duration = 3000) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 shadow-lg ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' :
        'bg-blue-500'
    }`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} mr-2"></i>
            ${message}
        </div>
    `;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, duration);
}

// Add error handling for missing Chart.js
if (typeof Chart === 'undefined') {
    document.addEventListener('DOMContentLoaded', function() {
        showNotification('Chart.js library failed to load. Please refresh the page.', 'error', 5000);
    });
}
</script>

{% endblock %}