{% extends 'accounts/base.html' %}

{% block title %}Complete Your Profile{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Progress Header -->
        <div class="text-center mb-8">
            <div class="mx-auto h-16 w-16 bg-blue-600 rounded-full flex items-center justify-center mb-4">
                <svg class="h-10 w-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Complete Your Profile</h1>
            <p class="text-lg text-gray-600">Help us match you with the best surveys</p>
            
            <!-- Progress Bar -->
            <div class="mt-6">
                <div class="flex justify-between text-sm text-gray-600 mb-2">
                    <span>Profile Completion</span>
                    <span id="completion-percentage">{{ profile_completion }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: {{ profile_completion }}%"></div>
                </div>
            </div>
        </div>

        <!-- Completion Wizard -->
        <div class="bg-white shadow-lg rounded-lg border border-gray-200 overflow-hidden">
            <!-- Steps Header -->
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-900">Profile Setup</h2>
                    <div class="flex items-center space-x-2">
                        <div class="flex items-center space-x-1">
                            {% for i in "123" %}
                            <div class="h-2 w-8 rounded-full {% if forloop.counter <= 2 %}bg-blue-600{% else %}bg-gray-300{% endif %}"></div>
                            {% endfor %}
                        </div>
                        <span class="text-sm text-gray-500">Step 2 of 3</span>
                    </div>
                </div>
            </div>

            <!-- Form -->
            <form method="post" class="p-6">
                {% csrf_token %}
                
                <!-- Welcome Message -->
                <div class="mb-8 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-blue-800">Welcome to SurveyEarn, {{ user.first_name|default:user.username }}!</h3>
                            <div class="mt-2 text-sm text-blue-700">
                                <p>Complete your profile to unlock surveys and start earning. The more complete your profile, the more surveys you'll qualify for!</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Required Fields Section -->
                <div class="mb-8">
                    <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                        <span class="flex items-center justify-center h-6 w-6 rounded-full bg-red-100 text-red-600 text-xs font-bold mr-3">!</span>
                        Required Information
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="{{ form.first_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                First Name *
                            </label>
                            {{ form.first_name }}
                            {% if form.first_name.errors %}
                                <div class="mt-1 text-sm text-red-600">
                                    {% for error in form.first_name.errors %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div>
                            <label for="{{ form.last_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                Last Name *
                            </label>
                            {{ form.last_name }}
                            {% if form.last_name.errors %}
                                <div class="mt-1 text-sm text-red-600">
                                    {% for error in form.last_name.errors %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="md:col-span-2">
                            <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                Email Address *
                            </label>
                            {{ form.email }}
                            <p class="mt-1 text-sm text-gray-500">We'll send you a verification email after setup</p>
                            {% if form.email.errors %}
                                <div class="mt-1 text-sm text-red-600">
                                    {% for error in form.email.errors %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="md:col-span-2">
                            <label for="{{ form.date_of_birth.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                Date of Birth *
                            </label>
                            {{ form.date_of_birth }}
                            <p class="mt-1 text-sm text-gray-500">Used to determine survey eligibility (must be 13 or older)</p>
                            {% if form.date_of_birth.errors %}
                                <div class="mt-1 text-sm text-red-600">
                                    {% for error in form.date_of_birth.errors %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Optional Fields Section -->
                <div class="mb-8">
                    <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                        <span class="flex items-center justify-center h-6 w-6 rounded-full bg-green-100 text-green-600 text-xs font-bold mr-3">+</span>
                        Additional Information
                        <span class="ml-2 text-sm font-normal text-gray-500">(helps us find better surveys for you)</span>
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="{{ form.phone_number.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                Phone Number
                            </label>
                            {{ form.phone_number }}
                            <p class="mt-1 text-sm text-gray-500">For M-Pesa withdrawals and security</p>
                            {% if form.phone_number.errors %}
                                <div class="mt-1 text-sm text-red-600">
                                    {% for error in form.phone_number.errors %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div>
                            <label for="{{ form.location.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                Location
                            </label>
                            {{ form.location }}
                            <p class="mt-1 text-sm text-gray-500">City or region (e.g., Nairobi, Kenya)</p>
                            {% if form.location.errors %}
                                <div class="mt-1 text-sm text-red-600">
                                    {% for error in form.location.errors %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="md:col-span-2">
                            <label for="{{ form.bio.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                About You
                            </label>
                            {{ form.bio }}
                            <p class="mt-1 text-sm text-gray-500">Brief description of your interests and background</p>
                            {% if form.bio.errors %}
                                <div class="mt-1 text-sm text-red-600">
                                    {% for error in form.bio.errors %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Benefits Preview -->
                <div class="mb-8 p-6 bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">What you'll unlock:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="h-8 w-8 bg-green-100 rounded-full flex items-center justify-center">
                                    <svg class="h-5 w-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900">Access to all surveys</p>
                                <p class="text-sm text-gray-600">Browse and complete available surveys</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="h-8 w-8 bg-green-100 rounded-full flex items-center justify-center">
                                    <svg class="h-5 w-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900">Earn and withdraw money</p>
                                <p class="text-sm text-gray-600">Request payouts to your preferred method</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="h-8 w-8 bg-green-100 rounded-full flex items-center justify-center">
                                    <svg class="h-5 w-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900">Personalized recommendations</p>
                                <p class="text-sm text-gray-600">Surveys matched to your profile</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="h-8 w-8 bg-green-100 rounded-full flex items-center justify-center">
                                    <svg class="h-5 w-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 8A8 8 0 11.01 8a8 8 0 0117.99 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900">Priority support</p>
                                <p class="text-sm text-gray-600">Faster response to your questions</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <a href="{% url 'accounts:dashboard' %}" 
                       class="w-full sm:w-auto px-6 py-3 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors text-center">
                        Skip for Now
                    </a>
                    
                    <button type="submit" id="submit-button"
                            class="w-full sm:w-auto bg-gray-400 text-white px-8 py-3 rounded-md font-medium cursor-not-allowed" 
                            disabled>
                        Complete Required Fields (0/4)
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Help Section -->
        <div class="mt-8 text-center">
            <p class="text-sm text-gray-600">
                Need help? 
                <a href="#" class="text-blue-600 hover:text-blue-500 font-medium">Contact our support team</a>
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const inputs = form.querySelectorAll('input, textarea, select');
    const progressBar = document.getElementById('progress-bar');
    const percentageText = document.getElementById('completion-percentage');
    
    // Required fields for completion
    const requiredFields = ['{{ form.first_name.id_for_label }}', '{{ form.last_name.id_for_label }}', '{{ form.email.id_for_label }}', '{{ form.date_of_birth.id_for_label }}'];
    const optionalFields = ['{{ form.phone_number.id_for_label }}', '{{ form.location.id_for_label }}', '{{ form.bio.id_for_label }}'];
    
    // Real-time progress updates
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            updateProgress();
        });
    });
    
    function updateProgress() {
        let completedRequired = 0;
        let completedOptional = 0;
        
        // Check required fields
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field && field.value.trim()) {
                completedRequired++;
            }
        });
        
        // Check optional fields
        optionalFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field && field.value.trim()) {
                completedOptional++;
            }
        });
        
        // Calculate percentage (required fields are weighted more)
        const totalFields = requiredFields.length + optionalFields.length + 1; // +1 for email verification
        const completedFields = completedRequired + completedOptional;
        const percentage = Math.round((completedFields / totalFields) * 100);
        
        // Update progress bar
        progressBar.style.width = percentage + '%';
        percentageText.textContent = percentage + '%';
        
        // Update submit button state
        const submitButton = document.getElementById('submit-button');
        const allRequiredComplete = completedRequired === requiredFields.length;
        
        if (allRequiredComplete) {
            submitButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
            submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700', 'cursor-pointer');
            submitButton.disabled = false;
            submitButton.textContent = 'Complete Profile & Continue';
        } else {
            submitButton.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'cursor-pointer');
            submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            submitButton.disabled = true;
            submitButton.textContent = `Complete Required Fields (${completedRequired}/${requiredFields.length})`;
        }
    }
    
    // Initial progress calculation
    updateProgress();
    
    // Form submission with validation
    form.addEventListener('submit', function(e) {
        const submitButton = document.getElementById('submit-button');
        
        // Check if all required fields are completed
        let allRequiredComplete = true;
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (!field || !field.value.trim()) {
                allRequiredComplete = false;
            }
        });
        
        if (!allRequiredComplete) {
            e.preventDefault();
            showNotification('Please complete all required fields before continuing.', 'error');
            return;
        }
        
        // Show loading state
        submitButton.disabled = true;
        submitButton.classList.add('cursor-not-allowed');
        submitButton.textContent = 'Completing Profile...';
        
        // Create loading spinner
        const spinner = document.createElement('div');
        spinner.className = 'inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2';
        submitButton.prepend(spinner);
    });
    
    // Real-time field validation
    const emailField = document.getElementById('{{ form.email.id_for_label }}');
    if (emailField) {
        emailField.addEventListener('blur', function() {
            const email = this.value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (email && !emailRegex.test(email)) {
                showFieldError(this, 'Please enter a valid email address');
            } else if (email) {
                clearFieldError(this);
                showFieldSuccess(this, 'Email format is valid');
            }
        });
    }
    
    const dobField = document.getElementById('{{ form.date_of_birth.id_for_label }}');
    if (dobField) {
        dobField.addEventListener('blur', function() {
            if (!this.value) return;
            
            const dob = new Date(this.value);
            const today = new Date();
            const age = today.getFullYear() - dob.getFullYear();
            
            if (age < 13) {
                showFieldError(this, 'You must be at least 13 years old to join');
            } else if (age > 120) {
                showFieldError(this, 'Please enter a valid date of birth');
            } else {
                clearFieldError(this);
                showFieldSuccess(this, `Age: ${age} years`);
            }
        });
    }
    
    // Phone number formatting
    const phoneField = document.getElementById('{{ form.phone_number.id_for_label }}');
    if (phoneField) {
        phoneField.addEventListener('input', function() {
            let value = this.value.replace(/\D/g, '');
            
            // Format for Kenyan numbers
            if (value.startsWith('254')) {
                value = '+' + value.substring(0, 3) + ' ' + value.substring(3, 6) + ' ' + value.substring(6, 9) + ' ' + value.substring(9, 12);
            } else if (value.startsWith('0') && value.length > 1) {
                value = '+254 ' + value.substring(1, 4) + ' ' + value.substring(4, 7) + ' ' + value.substring(7, 10);
            }
            
            this.value = value;
        });
    }
});

function showFieldError(field, message) {
    clearFieldError(field);
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'field-error mt-1 text-sm text-red-600 flex items-center';
    errorDiv.innerHTML = `
        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
        </svg>
        ${message}
    `;
    
    field.parentElement.appendChild(errorDiv);
    field.classList.add('border-red-300', 'focus:border-red-500', 'focus:ring-red-500');
}

function showFieldSuccess(field, message) {
    clearFieldError(field);
    
    const successDiv = document.createElement('div');
    successDiv.className = 'field-error mt-1 text-sm text-green-600 flex items-center';
    successDiv.innerHTML = `
        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
        </svg>
        ${message}
    `;
    
    field.parentElement.appendChild(successDiv);
    field.classList.remove('border-red-300', 'focus:border-red-500', 'focus:ring-red-500');
    field.classList.add('border-green-300', 'focus:border-green-500', 'focus:ring-green-500');
}

function clearFieldError(field) {
    const existingError = field.parentElement.querySelector('.field-error');
    if (existingError) {
        existingError.remove();
    }
    
    field.classList.remove('border-red-300', 'focus:border-red-500', 'focus:ring-red-500');
    field.classList.remove('border-green-300', 'focus:border-green-500', 'focus:ring-green-500');
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 max-w-sm ${
        type === 'success' ? 'bg-green-50 border border-green-200 text-green-700' :
        type === 'error' ? 'bg-red-50 border border-red-200 text-red-700' :
        type === 'warning' ? 'bg-yellow-50 border border-yellow-200 text-yellow-700' :
        'bg-blue-50 border border-blue-200 text-blue-700'
    }`;
    
    notification.innerHTML = `
        <div class="flex">
            <div class="ml-3">
                <p class="text-sm font-medium">${message}</p>
            </div>
            <div class="ml-auto pl-3">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="inline-flex text-sm">
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}
</script>
{% endblock %}